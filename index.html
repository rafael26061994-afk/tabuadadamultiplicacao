<!doctype html> 
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tabuada da Multiplica√ß√£o - Fase 4</title>
<style>
  :root {
    --bg: #0f1724; --card: #0b1220; --text: #e6eef8; --accent: #ff6b6b;
    --primary: #4f46e5; --success: #10b981; --danger: #ef4444;
    --muted: #94a3b8; --focus: #ffd166; --radius: 12px; --glass: rgba(255,255,255,0.03);
    --max-width: 900px;
  }
  body.light {
    --bg: #ffffff; --card: #f9f9f9; --text: #111111; --accent: #e63946;
    --primary: #1d4ed8; --success: #059669; --danger: #dc2626; --muted: #555555;
    --focus: #f59e0b; --glass: rgba(0,0,0,0.05);
  }
  *{box-sizing:border-box} html,body{height:100%} body{
    margin:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto;
    background: var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
    padding:24px; display:flex; align-items:flex-start; justify-content:center;
    transition: background 0.3s, color 0.3s;
  }
  .wrap{width:100%;max-width:var(--max-width);background:var(--card);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(2,6,23,0.5);}
  header{display:flex;align-items:center;gap:16px;margin-bottom:12px;}
  h1{margin:0;font-size:1.8rem;}
  .subtitle{color:var(--muted);font-size:0.9rem;}
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:18px;justify-content:space-between;}
  main{display:grid;grid-template-columns:1fr 320px;gap:18px;}
  @media (max-width:880px){main{grid-template-columns:1fr;}}
  .card{background:var(--glass);padding:18px;border-radius:var(--radius);min-height:140px;position:relative;transition: background 0.3s, transform 0.2s;}
  .question{display:flex;flex-direction:column;gap:12px;}
  .q-text{font-size:1.4rem;font-weight:600;text-align:center;transition: background 0.3s, color 0.3s; padding:10px; border-radius:8px;}
  .answers{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
  .answer-btn{background:var(--primary);color:#fff;border:none;padding:14px;border-radius:10px;font-size:1.1rem;cursor:pointer;transition: transform .08s ease, box-shadow .12s ease;text-align:left;}
  .answer-btn span{font-weight:bold;margin-right:6px;color:var(--focus);}
  .answer-btn:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(0,0,0,0.2);}
  .answer-btn:active{transform:scale(0.98)}
  .flash-success{background:var(--success)!important; animation: flashSuccess 0.3s;}
  .flash-error{background:var(--danger)!important; animation: flashError 0.3s;}
  @keyframes flashSuccess{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
  @keyframes flashError{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
  .mascot{display:flex;align-items:center;justify-content:center;height:200px;border-radius:12px;transition: transform 0.3s;}
  .mascot svg{width:160px;height:160px;}
  .score-row{display:flex;justify-content:space-between;align-items:center;}
  .progress{width:100%;height:12px;border-radius:999px;background:rgba(0,0,0,0.15);overflow:hidden;}
  .progress > span{display:block;height:100%;width:0%;border-radius:999px;transition: width .45s ease, background .45s ease;}
  .time-bar{position:absolute;bottom:0;left:0;height:6px;width:100%;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;}
  .time-bar > span{display:block;height:100%;width:100%;background:var(--accent);transition:width 0.2s linear;}
  .muted{color:var(--muted);font-size:0.9rem}
  .big{font-size:1.2rem;font-weight:600}
  footer{margin-top:20px;color:var(--muted);font-size:0.9rem;text-align:center}
  .about{margin-top:20px;padding:15px;border-top:1px solid rgba(0,0,0,0.1);font-size:0.9rem;line-height:1.5;color:var(--text);}
  .options{margin-bottom:16px;padding:10px;background:var(--glass);border-radius:var(--radius);}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Tabuada da Multiplica√ß√£o - Fase 4">
  <header>
    <h1>Tabuada da Multiplica√ß√£o - Fase 4</h1>
    <div style="margin-left:auto" class="controls">
      <button id="btnTheme" title="Alternar tema">üåô</button>
      <button id="btnVoice" title="Ler pergunta em voz alta">üîä</button>
      <button id="btnVLibras" title="VLibras">ü§ü</button>
    </div>
  </header>

  <div class="subtitle">Racioc√≠nio & divers√£o ‚Äî 0 a 20</div>

  <div class="topbar">
    <div class="muted">Escolha o modo: 
      <label><input type="radio" name="mode" value="timed" checked> Teste r√°pido com tempo</label> |
      <label><input type="radio" name="mode" value="relax"> Sem tempo</label>
    </div>
    <div class="muted">Use as teclas <strong>1</strong> a <strong>4</strong> para responder</div>
  </div>

  <div class="options">
    <label><input type="checkbox" id="autoVLibras"> Auto VLibras</label>
    <label style="margin-left:12px;"><input type="checkbox" id="autoRead"> Ler pergunta automaticamente</label>
  </div>

  <main>
    <section class="card question">
      <div id="qTitle" class="q-text" aria-live="polite">Carregando...</div>
      <div class="time-bar"><span id="timeBar"></span></div>
      <div id="answers" class="answers">
        <button class="answer-btn" data-index="0"><span>1)</span> A</button>
        <button class="answer-btn" data-index="1"><span>2)</span> B</button>
        <button class="answer-btn" data-index="2"><span>3)</span> C</button>
        <button class="answer-btn" data-index="3"><span>4)</span> D</button>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:10px">
        <div class="muted">Progresso: <span id="progressText">0/10</span></div>
        <div class="muted">Streak: <span id="streak">0</span></div>
      </div>
      <div class="muted">N√≠vel atual: <span id="levelName">F√°cil</span></div>
    </section>

    <aside>
      <div class="card mascot" id="mascot">
        <svg viewBox="0 0 200 200" id="mascotSvg">
          <circle cx="100" cy="90" r="50" fill="#ffdca8" />
          <circle cx="80" cy="85" r="6" fill="#111"/>
          <circle cx="120" cy="85" r="6" fill="#111"/>
          <path id="mouth" d="M75 110 Q100 125 125 110" stroke="#222" stroke-width="4" fill="transparent" stroke-linecap="round"/>
        </svg>
      </div>

      <div class="card" style="display:flex; flex-direction:column; gap:10px;">
        <div class="score-row">
          <div><div class="muted">Pontua√ß√£o</div><div class="big" id="score">0</div></div>
          <div style="text-align:right"><div class="muted">Quest√µes</div><div class="big" id="qcount">0</div></div>
        </div>
        <div>
          <div class="muted">Barra de Progresso</div>
          <div class="progress"><span id="progressBar" style="width:0%"></span></div>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    <div class="about">
      <strong>Sobre o Criador</strong><br>
      Rafael √© professor de Matem√°tica do Ensino Fundamental ‚Äì Anos Finais (6¬∫ ao 9¬∫ ano) na Escola Municipal Vereador Jos√© Ferreira de Aguiar, no bairro Icaivera, em Contagem/MG. Atua com estudantes de 10 a 15 anos, em um contexto de infraestrutura limitada e inclus√£o de estudantes da Educa√ß√£o Especial. Pessoa com defici√™ncia (monoparesia do lado direito), desenvolve pr√°ticas pedag√≥gicas acess√≠veis, com foco em tecnologia, √©tica e inclus√£o. O projeto nasceu da percep√ß√£o de que muitos estudantes t√™m dificuldades com a matem√°tica por n√£o dominarem a tabuada ‚Äî lacuna que ele busca preencher com uma abordagem l√∫dica e acess√≠vel.
    </div>
  </footer>
</div>

<!-- VLibras widget -->
<div vw class="enabled">
  <div vw-access-button class="active"></div>
  <div vw-plugin-wrapper><div class="vw-plugin-top-wrapper"></div></div>
</div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>const vlibrasWidget = new window.VLibras.Widget('https://vlibras.gov.br/app');</script>

<script>
(() => {
  const levels = [
    {name:'F√°cil', min:0,max:5, total:110},
    {name:'Intermedi√°rio', min:6,max:10, total:110},
    {name:'Avan√ßado', min:11,max:20, total:20}
  ];
  const state = {
    score:0, questionIndex:0, totalQuestions:levels[0].total,
    consecutiveCorrect:0, locked:false, currentQuestion:null,
    timer:null, timeLeft:8, maxTime:8, levelIndex:0, maxStreak:0,
    questionList:[], usedQuestions:new Set()
  };

  const qText = document.getElementById('qTitle'),
        answerButtons = [...document.querySelectorAll('.answer-btn')],
        scoreEl = document.getElementById('score'),
        qcountEl = document.getElementById('qcount'),
        progressText = document.getElementById('progressText'),
        progressBar = document.getElementById('progressBar'),
        streakEl = document.getElementById('streak'),
        mouthPath = document.getElementById('mouth'),
        timeBar = document.getElementById('timeBar'),
        levelName = document.getElementById('levelName');

  let modeTimed = true;
  let autoVLibras = false;
  let autoRead = false;

  document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change', e=>{
    modeTimed = e.target.value === 'timed';
    resetGame();
  }));

  document.getElementById('autoVLibras').addEventListener('change', e => autoVLibras=e.target.checked);
  document.getElementById('autoRead').addEventListener('change', e => autoRead=e.target.checked);

  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  function generateQuestionList(level){
    const list=[];
    for(let i=level.min;i<=level.max;i++){
      for(let j=level.min;j<=level.max;j++){
        list.push({a:i,b:j,correct:i*j});
      }
    }
    return shuffle(list).slice(0, level.total);
  }

  function generateOptions(correct){
    const set=new Set([correct]);
    while(set.size<4){
      let c = correct + randInt(-Math.max(1,correct), Math.max(1,correct));
      if(c<0)c=Math.abs(c);
      set.add(c);
    }
    return [...set];
  }

  function speakQuestion(q){
    if(autoRead){
      const utter = new SpeechSynthesisUtterance(`Quanto √© ${q.a} vezes ${q.b}?`);
      utter.lang='pt-BR';
      speechSynthesis.speak(utter);
    }
  }

  function renderQuestion(q){
    qText.textContent=`Quanto √© ${q.a} √ó ${q.b}?`;
    answerButtons.forEach((btn,i)=>{
      btn.innerHTML=`<span>${i+1})</span> ${q.options[i]}`;
      btn.dataset.value=q.options[i];
      btn.classList.remove('flash-success','flash-error');
      btn.disabled=false;
    });
    qcountEl.textContent=state.questionIndex;
    progressText.textContent=`${state.questionIndex}/${state.totalQuestions}`;
    levelName.textContent = levels[state.levelIndex].name;

    // Auto VLibras
    if(autoVLibras && window.VLibras){
      const input = document.querySelector('.vw-plugin-wrapper input[type=text]');
      if(input){
        input.value = `Quanto √© ${q.a} vezes ${q.b}?`;
        input.dispatchEvent(new Event('input'));
      }
    }

    speakQuestion(q);
  }

  function updateProgress(){
    progressBar.style.width = `${(state.questionIndex/state.totalQuestions)*100}%`;
    const percent = (state.questionIndex/state.totalQuestions)*100;
    if(percent<40) progressBar.style.background='var(--danger)';
    else if(percent<70) progressBar.style.background='var(--accent)';
    else progressBar.style.background='var(--success)';
    scoreEl.textContent = state.score;
    streakEl.textContent = state.consecutiveCorrect;
    if(state.consecutiveCorrect>state.maxStreak) state.maxStreak=state.consecutiveCorrect;
    updateMascot();
  }

  function updateMascot(){
    if(state.consecutiveCorrect>=5) mouthPath.setAttribute('d','M70 115 Q100 150 130 115');
    else if(state.consecutiveCorrect>0) mouthPath.setAttribute('d','M75 110 Q100 125 125 110');
    else mouthPath.setAttribute('d','M80 118 Q100 110 120 118');
  }

  function handleAnswer(val, btn){
    if(state.locked) return;
    state.locked = true;
    clearInterval(state.timer);
    const correct = state.currentQuestion.correct;
    if(val == correct){
      btn.classList.add('flash-success');
      state.score += modeTimed ? Math.ceil(state.timeLeft) : 1;
      state.consecutiveCorrect++;
    } else {
      btn.classList.add('flash-error');
      state.consecutiveCorrect=0;
    }
    setTimeout(()=>{btn.classList.remove('flash-success','flash-error'); nextQuestion();},500);
    updateProgress();
  }

  function nextQuestion(){
    state.locked=false;
    state.timeLeft=state.maxTime;
    if(state.questionList.length===0){
      state.questionList=generateQuestionList(levels[state.levelIndex]);
      state.totalQuestions=levels[state.levelIndex].total;
      state.questionIndex=0;
      state.usedQuestions.clear();
    }
    if(state.questionIndex>=state.totalQuestions){
      if(state.levelIndex<levels.length-1) state.levelIndex++;
      resetGame();
      return;
    }
    state.currentQuestion = {
      ...state.questionList[state.questionIndex],
      options: shuffle(generateOptions(state.questionList[state.questionIndex].correct))
    };
    state.questionIndex++;
    renderQuestion(state.currentQuestion);
    updateProgress();
    if(modeTimed) startTimer();
  }

  function startTimer(){
    clearInterval(state.timer);
    state.timer=setInterval(()=>{
      state.timeLeft-=0.2;
      if(state.timeLeft<0) state.timeLeft=0;
      timeBar.style.width=`${(state.timeLeft/state.maxTime)*100}%`;
      if(state.timeLeft<=3){
        qText.style.background='#ef444480';
        if(!state.alerted){state.alerted=true; new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();}
      } else if(state.timeLeft<=5) qText.style.background='#ffd16680';
      else qText.style.background='#10b98140';
      if(state.timeLeft<=0){clearInterval(state.timer); state.consecutiveCorrect=0; updateProgress(); nextQuestion();}
    },200);
    state.alerted=false;
  }

  function resetGame(){
    clearInterval(state.timer);
    state.score=0; state.questionIndex=0; state.consecutiveCorrect=0; state.maxStreak=0;
    state.questionList=[]; state.usedQuestions.clear();
    nextQuestion();
  }

  answerButtons.forEach(btn=>btn.addEventListener('click',e=>handleAnswer(e.currentTarget.dataset.value,e.currentTarget)));
  document.addEventListener('keydown',e=>{
    if(['1','2','3','4'].includes(e.key)){
      const idx=parseInt(e.key)-1;
      const btn=answerButtons[idx];
      if(btn) handleAnswer(btn.dataset.value, btn);
    }
  });

  document.getElementById('btnTheme').addEventListener('click',()=>{
    document.body.classList.toggle('light');
    document.getElementById('btnTheme').textContent=document.body.classList.contains('light')?'‚òÄÔ∏è':'üåô';
  });

  document.getElementById('btnVoice').addEventListener('click',()=>speakQuestion(state.currentQuestion));

  nextQuestion();
})();
</script>
</body>
</html>
